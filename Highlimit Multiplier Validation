/**
 * Performs a combined data extraction and VLOOKUP operation, including a second VLOOKUP
 * for a multiplier based on the calculated paylines.
 *
 * * Assumes:
 * 1. The full data source is the 'Input' sheet.
 * 2. Slot lookup data (ID, Name, Paylines) is in fixed columns AU, AV, AW of 'Input'.
 * 3. Multiplier lookup data (Paylines Key, Multiplier Value) is in columns A, B
 * of the 'Multiplier for HL Slots (100M)' sheet.
 */
function simplifiedSlotVlookup() {
  
  // --- CONFIGURATION ---
  // The sheet that contains ALL the data (keys, data to extract, and slot lookup table)
  const INPUT_SHEET_NAME = 'Input'; 
  // The sheet where the final 5-column result will be written
  const RESULTS_SHEET_NAME = 'Results_VLookup_Output'; 
  // The sheet containing the payline-to-multiplier lookup table
  const MULTIPLIER_SHEET_NAME = 'Multiplier for HL Slots (100M)';

  // Headers to search for in the 'Input' sheet for the key data
  const INPUT_COL_SLOT_ID = 'document__track_items__slot_id';
  const INPUT_COL_BET_MOD = 'document__track_items__bet_modifier';
  
  // Index of the slotsList__id column in the INPUT_SHEET (Input!AU is column 47)
  const LOOKUP_ID_COL_INDEX = 47; 
  // Index of the slotsList__name column in the INPUT_SHEET (Input!AV is column 48)
  const LOOKUP_NAME_COL_INDEX = 48;
  // Index of the slotsList__paylines column in the INPUT_SHEET (Input!AW is column 49)
  const LOOKUP_PAYLINES_COL_INDEX = 49;

  // Output column headers (for the new Results sheet)
  const LOOKUP_COL_NAME = 'slotsList__name';
  const LOOKUP_COL_PAYLINES = 'slotsList__paylines';
  const MULTIPLIER_OUTPUT_HEADER = 'Payline Multiplier (100M)'; // NEW OUTPUT COLUMN
  // ---------------------

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const ui = SpreadsheetApp.getUi();

  // --- Step 1: Validate Sheets ---
  let resultsSheet = ss.getSheetByName(RESULTS_SHEET_NAME);
  const inputSheet = ss.getSheetByName(INPUT_SHEET_NAME);
  const multiplierSheet = ss.getSheetByName(MULTIPLIER_SHEET_NAME); // NEW SHEET

  if (!inputSheet) {
    ui.alert('Setup Error', 
      `The required input sheet ('${INPUT_SHEET_NAME}') is missing. Please ensure it exists.`, 
      ui.ButtonSet.OK);
    return;
  }
  
  if (!multiplierSheet) {
     ui.alert('Setup Error', 
      `The required multiplier sheet ('${MULTIPLIER_SHEET_NAME}') is missing. Please ensure it exists.`, 
      ui.ButtonSet.OK);
    return;
  }
  
  // --- Step 2: Build the Slot Lookup Map from the 'Input' sheet (Columns AU-AW) ---
  const lastLookupRow = inputSheet.getLastRow();
  // Read columns AU to AW from the Input sheet (Index 47 to 49)
  const lookupRange = inputSheet.getRange(1, LOOKUP_ID_COL_INDEX, lastLookupRow, 3);
  const lookupData = lookupRange.getValues();
  
  const slotMap = new Map();

  for (let i = 1; i < lookupData.length; i++) {
    const row = lookupData[i];
    const id = String(row[0]).trim(); 
    const name = row[1];
    const paylines = row[2];

    if (id) {
      slotMap.set(id, [name, paylines]);
    }
  }

  // --- Step 2a: Build the Multiplier Lookup Map --- (NEW STEP)
  const lastMultiplierRow = multiplierSheet.getLastRow();
  // Read columns A and B from the Multiplier sheet
  const multiplierRange = multiplierSheet.getRange(1, 1, lastMultiplierRow, 2); 
  const multiplierData = multiplierRange.getValues();
  
  const multiplierMap = new Map();

  for (let i = 1; i < multiplierData.length; i++) {
    const row = multiplierData[i];
    // Key is in column A (index 0), Value is in column B (index 1)
    // Payline key must be trimmed and converted to string for robust matching
    const paylineKey = String(row[0]).trim(); 
    const multiplierValue = row[1];

    if (paylineKey) {
      multiplierMap.set(paylineKey, multiplierValue);
    }
  }

  // --- Step 3: Read and Prepare All Data from 'Input' Sheet ---
  const inputDataRange = inputSheet.getDataRange();
  const inputData = inputDataRange.getValues();
  const inputHeaders = inputData[0];
  
  // Dynamically find the column indices for the required fields (0-based index)
  const slotIdColIndex = inputHeaders.indexOf(INPUT_COL_SLOT_ID);
  const betModColIndex = inputHeaders.indexOf(INPUT_COL_BET_MOD);

  if (slotIdColIndex === -1 || betModColIndex === -1) {
    ui.alert('Header Error', 
      `Could not find required input headers in the '${INPUT_SHEET_NAME}' sheet: **${INPUT_COL_SLOT_ID}** or **${INPUT_COL_BET_MOD}**. Please check for typos.`, 
      ui.ButtonSet.OK);
    return;
  }

  // --- Step 4: Process the data and prepare the output array ---
  
  // Define the output header row in the requested order
  const outputHeaders = [
    INPUT_COL_SLOT_ID, 
    LOOKUP_COL_NAME, 
    LOOKUP_COL_PAYLINES, 
    INPUT_COL_BET_MOD,
    MULTIPLIER_OUTPUT_HEADER // NEW COLUMN
  ];
  const outputData = [outputHeaders];

  // Start processing from row 1 (skipping header row 0)
  for (let i = 1; i < inputData.length; i++) {
    const row = inputData[i];
    
    // Read the primary key values
    const slotId = String(row[slotIdColIndex]).trim();
    const betModifier = row[betModColIndex];
    
    // --- First VLOOKUP (Slot Details) ---
    const slotDetailResult = slotMap.get(slotId);
    
    const slotName = slotDetailResult ? slotDetailResult[0] : '#N/A';
    const paylines = slotDetailResult ? slotDetailResult[1] : '#N/A';
    
    // --- Second VLOOKUP (Multiplier based on Paylines) ---
    // Prepare the paylines value as a string key for the multiplier map lookup
    const paylineKey = String(paylines).trim();
    const multiplierResult = multiplierMap.get(paylineKey);
    
    const multiplierValue = multiplierResult !== undefined ? multiplierResult : '#N/A';

    // Assemble the new output row
    outputData.push([
      slotId,
      slotName,
      paylines,
      betModifier,
      multiplierValue // NEW VALUE
    ]);
  }

  // --- Step 5: Write results to the designated Results sheet ---
  if (!resultsSheet) {
    resultsSheet = ss.insertSheet(RESULTS_SHEET_NAME);
  }
  
  // Clear only the necessary content area before writing new data
  if (resultsSheet.getLastRow() > 0) {
      resultsSheet.getRange(1, 1, resultsSheet.getMaxRows(), outputHeaders.length).clearContent();
  }
  
  // Write all processed data in a single batch operation
  resultsSheet
    .getRange(1, 1, outputData.length, outputData[0].length)
    .setValues(outputData);

  ui.alert('Success! ðŸŽ‰', 
    `The 5-column final report, including the Payline Multiplier, has been written to **${RESULTS_SHEET_NAME}**.`, 
    ui.ButtonSet.OK);
}
